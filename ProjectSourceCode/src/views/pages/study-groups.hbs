{{!< layouts/main }}

<div class="page">
  <div class="container">
    <main>
      <div class="card">
        <h1>Study Groups</h1>
        <p class="subtitle">manage friends & group study sessions</p>

        <!-- Create Group Button -->
        <button class="btn-primary" id="openCreateGroupModal" style="width: 200px; margin-bottom: 16px;">
          + Create Study Group
        </button>

        <div class="groups-section">
          <h2>Your Study Groups</h2>
          {{#if studyGroups.length}}
            <div class="group-list">
              {{#each studyGroups}}
                <div class="group-item">
                  <div>
                    <div class="group-title">{{this.name}}</div>
                    <div class="group-details">
                      <strong>{{this.category}}</strong> |
                      {{formatDate this.date}} {{formatTime this.start_time}}–{{formatTime this.end_time}}
                      <br>
                      Host: {{this.host_username}}
                    </div>
                    {{!-- <div class="group-members">
                      {{#each this.members}}
                        <span class="member-tag">{{this}}</span>
                      {{/each}}
                    </div> --}}
                    {{!-- Only show Edit if this user is the host --}}
                      <button class="btn-link" onclick="window.open('{{this.meeting_link}}', '_blank')">Join Meeting</button>
                    {{#if (eq this.host_username ../user.username)}}
                      <button class="btn-secondary edit-btn" data-group-id="{{this.id}}">Edit</button>
                      <button class="btn-danger delete-btn" data-group-id="{{this.id}}">Delete</button>
                    {{/if}}
                  </div>
                </div>
              {{/each}}
            </div>
          {{else}}
            <p>No study groups yet. Create one!</p>
          {{/if}}
        </div>

        <hr style="margin: 24px 0;">

        <div class="friends-section">
          <h2>Your Friends</h2>
          {{#if friends.length}}
            <div class="friends-list">
              {{#each friends}}
                <div class="friend-item">
                  <div class="friend-name">{{this}}</div>
                </div>
              {{/each}}
            </div>
          {{else}}
            <p>You have no friends added yet.</p>
          {{/if}}
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Create Group Modal -->
<div id="groupModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Create Study Group</h3>
      <button class="modal-close" id="closeModal">&times;</button>
    </div>

    <div class="modal-body">
      <form id="createGroupForm">
        <div class="field">
          <span class="label-sm">GROUP NAME</span>
          <input type="text" name="name" placeholder="Calculus Review" required>
        </div>

        <div class="field">
          <span class="label-sm">CATEGORY</span>
          <input type="text" name="category" placeholder="Homework / Exam Prep" required>
        </div>

        <div class="field">
          <span class="label-sm">DATE</span>
          <input type="date" name="date" required>
        </div>

        <div class="field">
          <span class="label-sm">START TIME</span>
          <input type="time" name="start_time" required>
        </div>

        <div class="field">
          <span class="label-sm">END TIME</span>
          <input type="time" name="end_time" required>
        </div>

        <div class="field">
          <span class="label-sm">MAX PARTICIPANTS</span>
          <input type="number" name="max_participants" min="1" value="5" required>
        </div>

        <div class="mb-3" id="create_group_url_group">
          <label for="event_remote_url" class="form-label">Group Meeting Link</label>
          <input 
              type="url" 
              class="form-control" 
              id="event_remote_url"
              name="event_remote_url"
              placeholder="https://example.com/meeting" 
              pattern="https?://.+" required/>
        </div>

        <div class="field">
          <span class="label-sm">ADD FRIENDS</span>
          <div class="friend-checkboxes">
            {{#each friends}}
              <label class="friend-checkbox">
                <input type="checkbox" name="members[]" value="{{this}}">
                {{this}}
              </label>
            {{/each}}
          </div>
        </div>

        <button class="btn-primary" type="submit">Create Group</button>
      </form>
    </div>
  </div>
</div>

<!-- Edit Group Modal -->
<div id="editGroupModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit Study Group</h3>
      <button class="modal-close" id="closeEditModal">&times;</button>
    </div>

    <div class="modal-body">
      <form id="editGroupForm">
        <input type="hidden" name="id" id="editGroupId">

        <div class="field">
          <span class="label-sm">GROUP NAME</span>
          <input type="text" name="name" id="editGroupName" required>
        </div>

        <div class="field">
          <span class="label-sm">CATEGORY</span>
          <input type="text" name="category" id="editGroupCategory" required>
        </div>

        <div class="field">
          <span class="label-sm">DATE</span>
          <input type="date" name="date" id="editGroupDate" required>
        </div>

        <div class="field">
          <span class="label-sm">START TIME</span>
          <input type="time" name="start_time" id="editGroupStartTime" required>
        </div>

        <div class="field">
          <span class="label-sm">END TIME</span>
          <input type="time" name="end_time" id="editGroupEndTime" required>
        </div>

        <div class="field">
          <span class="label-sm">MAX PARTICIPANTS</span>
          <input type="number" name="max_participants" id="editGroupMax" min="1" required>
        </div>

        <div class="mb-3" id="edit_group_url_group">
          <label for="edit_event_remote_url" class="form-label">Group Meeting Link</label>
          <input 
              type="url" 
              class="form-control" 
              id="edit_event_remote_url"
              name="meeting_link"
              placeholder="https://example.com/meeting" 
              pattern="https?://.+" required/>
        </div>

        <div class="friend-checkboxes">
          {{#each friends}}
            <label class="friend-checkbox">
              <input type="checkbox" name="members[]" value="{{this}}">
              {{this}}
            </label>
          {{/each}}
        </div>

        <button class="btn-primary" type="submit">Save Changes</button>
      </form>
    </div>
  </div>
</div>

<style>
  .container {
    display: flex;
    justify-content: center;
    padding: 10px; 
  }

  .group-list, .friends-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    max-width: 600px;
  }

  .groups-section, .friends-section {
    display: flex;
    flex-direction: column;
    align-items: center; /* centers the content horizontally */
    width: 100%;
  }

  .group-item {
    padding: 16px;
    border: 1px solid #d0d7de;
    border-radius: 8px;
    background: #f6f8fa;
  }

  .group-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .group-details {
    font-size: 13px;
    color: #57606a;
    margin-bottom: 8px;
  }

  .group-members {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .member-tag {
    background: #e8f0fe;
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 6px;
  }

  .friend-item {
    padding: 12px;
    border: 1px solid #d0d7de;
    border-radius: 6px;
    background: #fff;
  }

  .friend-name {
    font-size: 16px;
  }

  .friend-checkboxes {
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 8px 0;
  }

  .modal {
    display: none;     /* hidden by default */
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background: rgba(0,0,0,0.4);
}

.modal-content {
    background: #fff;
    margin: 10% auto;
    padding: 20px;
    width: 800px;
    border-radius: 8px;
    padding-right: 40px;
}

</style>

<script>
  const modal = document.getElementById("groupModal");
  const openBtn = document.getElementById("openCreateGroupModal");
  const closeBtn = document.getElementById("closeModal");
  const form = document.getElementById("createGroupForm");

  openBtn.onclick = () => {
    modal.style.display = "block";
  };

  closeBtn.onclick = () => {
    modal.style.display = "none";
  };

  window.onclick = (e) => {
    if (e.target === modal) modal.style.display = "none";
  };

  // Submit study group
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const payload = {
      name: formData.get("name"),
      category: formData.get("category"),
      date: formData.get("date"),
      start_time: formData.get("start_time"),
      end_time: formData.get("end_time"),
      max_participants: formData.get("max_participants"),
      meeting_link: formData.get("event_remote_url"),
      members: formData.getAll("members[]")
    };

    const res = await fetch("/study-groups/create", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      window.location.reload();
    } else {
      alert("Error creating group.");
    }
  });

  // Edit Group Modal
  const editModal = document.getElementById("editGroupModal");
  const closeEditBtn = document.getElementById("closeEditModal");
  const editForm = document.getElementById("editGroupForm");

  document.querySelectorAll(".edit-btn").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const groupId = btn.dataset.groupId;

      // Fetch the current group data from backend
      const res = await fetch(`/study-groups/${groupId}`);
      if (!res.ok) return alert("Failed to load group data.");

      const group = await res.json();

      // Fill the form
      document.getElementById("editGroupId").value = group.id;
      document.getElementById("editGroupName").value = group.name;
      document.getElementById("editGroupCategory").value = group.category;
      document.getElementById("editGroupDate").value = group.date;
      document.getElementById("editGroupStartTime").value = group.start_time;
      document.getElementById("editGroupEndTime").value = group.end_time;
      document.getElementById("editGroupMax").value = group.max_participants;
      document.getElementById("event_remote_url").value = group.meeting_link || '';

      // Show modal
      editModal.style.display = "block";
    });
  });

  closeEditBtn.onclick = () => {
    editModal.style.display = "none";
  };

  // Submit edit form
  editForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(editForm);

    const payload = {
      id: formData.get("id"),
      name: formData.get("name"),
      category: formData.get("category"),
      date: formData.get("date"),
      start_time: formData.get("start_time"),
      end_time: formData.get("end_time"),
      max_participants: formData.get("max_participants"),
      meeting_link: formData.get("meeting_link"),

      // This is the key — preserve array!
      members: formData.getAll("members[]")
    };

    const res = await fetch(`/study-groups/edit/${payload.id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });


    if (res.ok) {
      window.location.reload();
    } else {
      alert("Error updating group.");
    }
  });

  //Handle delete button clicks
  document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const groupId = btn.dataset.groupId;
      if (!confirm('Are you sure you want to delete this study group?')) return;

      const res = await fetch(`/study-groups/delete/${groupId}`, {
        method: 'DELETE'
      });

      if (res.ok) {
        btn.closest('.group-item').remove(); // remove card without reload
      } else {
        const data = await res.json();
        alert('Error deleting group: ' + data.message);
      }
    });
  });
});

</script>
